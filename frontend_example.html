<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthGuard AI - Public Health Decision Support</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function HealthGuardApp() {
            const [query, setQuery] = useState('');
            const [isResearching, setIsResearching] = useState(false);
            const [agentResults, setAgentResults] = useState({
                'EPHT_Agent': [],
                'OpenData_Agent': [],
                'HealthcareAccess_Agent': [],
                'MedlinePlus_Agent': [],     // NEW
                'OpenFDA_Agent': []          // NEW
            });
            const [selectedAgents, setSelectedAgents] = useState([]);
            const [synthesis, setSynthesis] = useState('');
            const [coordinatorMessages, setCoordinatorMessages] = useState([]);
            
            const scrollRefs = {
                'EPHT_Agent': useRef(null),
                'OpenData_Agent': useRef(null),
                'HealthcareAccess_Agent': useRef(null),
                'MedlinePlus_Agent': useRef(null),     // NEW
                'OpenFDA_Agent': useRef(null)          // NEW
            };

            const agentConfigs = {
                'EPHT_Agent': {
                    name: 'Environmental Health',
                    icon: 'üåç',
                    color: 'green',
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-200',
                    textColor: 'text-green-800'
                },
                'OpenData_Agent': {
                    name: 'CDC Surveillance',
                    icon: 'üìä',
                    color: 'blue',
                    bgColor: 'bg-blue-50',
                    borderColor: 'border-blue-200',
                    textColor: 'text-blue-800'
                },
                'HealthcareAccess_Agent': {
                    name: 'Healthcare Access',
                    icon: 'üè•',
                    color: 'purple',
                    bgColor: 'bg-purple-50',
                    borderColor: 'border-purple-200',
                    textColor: 'text-purple-800'
                },
                'MedlinePlus_Agent': {
                    name: 'Patient Education',
                    icon: 'ü©∫',
                    color: 'teal',
                    bgColor: 'bg-teal-50',
                    borderColor: 'border-teal-200',
                    textColor: 'text-teal-800'
                },
                'OpenFDA_Agent': {
                    name: 'Drug Safety',
                    icon: '‚ö†Ô∏è',
                    color: 'red',
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-200',
                    textColor: 'text-red-800'
                }
            };

            const scrollToBottom = (agentName) => {
                const ref = scrollRefs[agentName];
                if (ref.current) {
                    ref.current.scrollTop = ref.current.scrollHeight;
                }
            };

            const addAgentMessage = (agentName, message, type = 'info') => {
                setAgentResults(prev => ({
                    ...prev,
                    [agentName]: [...prev[agentName], { message, type, timestamp: Date.now() }]
                }));
                setTimeout(() => scrollToBottom(agentName), 100);
            };

            const clearAllResults = () => {
                setAgentResults({
                    'EPHT_Agent': [],
                    'OpenData_Agent': [],
                    'HealthcareAccess_Agent': [],
                    'MedlinePlus_Agent': [],
                    'OpenFDA_Agent': []
                });
                setSynthesis('');
                setCoordinatorMessages([]);
                setSelectedAgents([]);
            };

            const handleResearch = async () => {
                if (!query.trim()) return;
                
                setIsResearching(true);
                clearAllResults();
                
                try {
                    const response = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: query })
                    });

                    if (!response.body) {
                        throw new Error('No response body');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    switch (data.type) {
                                        case 'agent_selection':
                                            setSelectedAgents(data.agents);
                                            setCoordinatorMessages(prev => [...prev, 
                                                `üéØ Selected ${data.agents.length} relevant agents: ${data.agents.join(', ')}`
                                            ]);
                                            break;
                                            
                                        case 'coordinator':
                                            setCoordinatorMessages(prev => [...prev, `ü§ñ ${data.content}`]);
                                            break;
                                            
                                        case 'research':
                                            if (data.agent && data.content) {
                                                addAgentMessage(data.agent, data.content, 'research');
                                            }
                                            break;
                                            
                                        case 'agent_complete':
                                            if (data.agent) {
                                                addAgentMessage(data.agent, `‚úÖ Research complete`, 'success');
                                            }
                                            break;
                                            
                                        case 'synthesis':
                                            setSynthesis(data.content);
                                            break;
                                            
                                        case 'complete':
                                            setIsResearching(false);
                                            break;
                                            
                                        case 'error':
                                            if (data.agent) {
                                                addAgentMessage(data.agent, `‚ùå ${data.content}`, 'error');
                                            }
                                            break;
                                    }
                                } catch (e) {
                                    console.warn('Failed to parse SSE data:', line);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Research error:', error);
                    setCoordinatorMessages(prev => [...prev, `‚ùå Error: ${error.message}`]);
                    setIsResearching(false);
                }
            };

            const exampleQueries = [
                "What are the latest FDA recalls for blood pressure medications and what patient education materials are available?",
                "Analyze fentanyl-related adverse events and provide patient education resources about opioid safety",
                "Compare air quality trends with respiratory health outcomes and provide patient guidance",
                "What are the current drug safety warnings for diabetes medications and related educational resources?"
            ];

                                return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                        <span className="text-white font-bold text-lg">üè•</span>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">HealthGuard AI</h1>
                                        <p className="text-sm text-gray-600">Public Health Decision Support System</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2 text-sm text-gray-600">
                                    <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                                    <span>5 Databases Connected</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        {/* Query Input Section */}
                        <div className="bg-white rounded-lg shadow-sm border p-6 mb-6">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Research Query
                                    </label>
                                    <textarea
                                        value={query}
                                        onChange={(e) => setQuery(e.target.value)}
                                        placeholder="Enter your public health research question..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        rows={3}
                                        disabled={isResearching}
                                    />
                                </div>
                                
                                <div className="flex items-center justify-between">
                                    <button
                                        onClick={handleResearch}
                                        disabled={isResearching || !query.trim()}
                                        className={`px-6 py-2 rounded-md font-medium flex items-center space-x-2 ${
                                            isResearching || !query.trim()
                                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                : 'bg-blue-600 text-white hover:bg-blue-700'
                                        }`}
                                    >
                                        {isResearching && <div className="loading-spinner"></div>}
                                        <span>{isResearching ? 'Researching...' : 'Start Research'}</span>
                                    </button>
                                    
                                    <button
                                        onClick={clearAllResults}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                                    >
                                        Clear Results
                                    </button>
                                </div>
                            </div>
                            
                            {/* Example Queries */}
                            <div className="mt-4 pt-4 border-t border-gray-200">
                                <p className="text-sm font-medium text-gray-700 mb-2">Example Queries:</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {exampleQueries.map((example, index) => (
                                        <button
                                            key={index}
                                            onClick={() => setQuery(example)}
                                            className="text-left text-sm text-blue-600 hover:text-blue-800 p-2 rounded border border-blue-200 hover:border-blue-300 transition-colors"
                                            disabled={isResearching}
                                        >
                                            {example}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Coordinator Messages */}
                        {coordinatorMessages.length > 0 && (
                            <div className="bg-gray-100 rounded-lg p-4 mb-6">
                                <h3 className="font-semibold text-gray-800 mb-2">ü§ñ Research Coordinator</h3>
                                <div className="space-y-1">
                                    {coordinatorMessages.map((message, index) => (
                                        <div key={index} className="text-sm text-gray-700">
                                            {message}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Agent Results Grid - Now supports 5 agents */}
                        {selectedAgents.length > 0 && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                                {selectedAgents.map((agentName) => {
                                    const config = agentConfigs[agentName];
                                    const results = agentResults[agentName] || [];
                                    
                                    return (
                                        <div key={agentName} className={`${config.bgColor} rounded-lg border ${config.borderColor} p-4`}>
                                            <h3 className={`font-semibold ${config.textColor} mb-3 flex items-center space-x-2`}>
                                                <span className="text-lg">{config.icon}</span>
                                                <span>{config.name}</span>
                                                {isResearching && results.length === 0 && (
                                                    <div className="loading-spinner ml-auto"></div>
                                                )}
                                            </h3>
                                            <div 
                                                ref={scrollRefs[agentName]}
                                                className="space-y-2 h-96 overflow-y-auto scroll-container"
                                            >
                                                {results.length === 0 && !isResearching && (
                                                    <div className="text-gray-500 text-sm italic">
                                                        Waiting for research to begin...
                                                    </div>
                                                )}
                                                {results.map((result, index) => (
                                                    <div 
                                                        key={index}
                                                        className={`text-sm p-2 rounded ${
                                                            result.type === 'error' 
                                                                ? 'bg-red-100 text-red-800' 
                                                                : result.type === 'success'
                                                                ? 'bg-green-100 text-green-800'
                                                                : 'bg-white text-gray-700'
                                                        }`}
                                                    >
                                                        {result.message}
                                                    </div>
                                                ))}
                                                {isResearching && results.length > 0 && (
                                                    <div className="flex items-center space-x-2 text-gray-500 text-sm">
                                                        <div className="loading-spinner"></div>
                                                        <span>Researching...</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* Synthesis Results */}
                        {synthesis && (
                            <div className="bg-white rounded-lg shadow-sm border p-6">
                                <div className="flex items-center space-x-2 mb-4">
                                    <span className="text-2xl">üìã</span>
                                    <h3 className="text-xl font-bold text-gray-900">Comprehensive Analysis Report</h3>
                                </div>
                                <div className="prose max-w-none">
                                    <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">
                                        {synthesis}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Footer */}
                        <footer className="mt-8 text-center text-sm text-gray-500">
                            <p>HealthGuard AI ‚Ä¢ Powered by CDC, FDA, and MedlinePlus databases ‚Ä¢ Real-time parallel analysis</p>
                        </footer>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<HealthGuardApp />, document.getElementById('root'));
    </script>
</body>
</html>